****
#### 今日面试题总结
1. 项目中使用过Redis的数据结构？
	很多，比如String、Hash、Set、SortedSet、BitMap等
	能不能具体说说使用的场景？
	比如很多缓存，我们就使用了String结构来存储，还有点赞功能，我们使用了Set结构和SortedSet结构。签到功能使用了BitMap结构
	> 就拿签到来说，因为签到数据量非常大，不可能在数据库中一条一条存储用户的点赞记录，而且因为签到业务的特殊性，可以使用1表示用户签到0表示未签到。因为我们要记录的是用户一个月的签到记录一个月最多有31天，想到使用Redis提供的bitmap数据结构，只使用了31bit就能表示1个月的签到记录，节省了大量空间而且因为Redis作为键值数据库查询效率也很高
	
2. 使用Redis保存签到记录，那如果Redis宕机怎么办？
	对于Redis的高可用数据安全问题，有多种方案：
	* 使用Redis数据持久化机制，比如AOF持久化，这样宕机后丢失的数据量不多，可以接受
	* Redis主从集群结合Redis哨兵，主节点会把数据持续的同步给从节点，宕机后也会有哨兵重新选主，基本不用担心数据丢失问题
	* 使用传统数据库，但是为了解决签到数据量较大的问题，我们可能就需要对数据做分表处理，或即使将历史数据存档
	总的来说，签到数据使用Redis的BitMap无论是安全性还是数据内存占用情况，都是可以接受的，但是具体选择Redis还是传统数据库方案，最终还是要看公司的要求来选择。
#### 签到功能
一开始的想法是使用MySQL数据库存储签到记录，主要字段有用户id，签到年份、签到月份、签到日期、是否补签等，但是考虑到如果一个用户签到100次，网站有100万用户，就会产生1亿条记录。随着用户量的增加、时间推移等因素影响，表中的数据将越来越多，占用的空间也会越来越大。
这时候考虑到签到功能的特殊性，我们只需要记录两种状态：签到或未签到；那么我们可以使用二进制来表示用户的情况，类似：10000001111，这样的数据来表示，考虑到一个月最多只有31天，可以使用一个长度为31bit的二进制数表示一个用户一个月的签到情况，Redis的数据结构BitMap提供了这样的功能。
##### BitMap
BitMap由0和1状态表现的二进制位bit数组
###### 基本命令
1. setbit key offset val：给指定key的值的第offset赋值val，val只能是1或0
2. getbit  key offset: 获取指定偏移量的val
3. bitcount key :统计key里面1的个数
##### 签到接口
个人中心的积分页面，用户可以每天签到一次，连续签到有积分奖励。
**键的设计**
因为要存储的是用户一个月的签到记录，遵循业务:数据:id:month的key设计，将签到功能的key设计为sign:uid:xxx:202306的这样的形式，方便获取和存储数据。
从key的设计可知，想要存储用户的签到记录，必须获取两个数据：
* 用户id
* 当前月份
这两个信息后端可以自己获取，无需前端传递。
**返回数据**
需求中要求连续签到会有积分奖励，那么为了提升用户体验，在用户签到成功后，需要返回连续签到天数和获取的积分奖励给前端。
##### 连续签到统计
如何获取连续签到天数？
首先需要获取本月到今日为止的所有签到数据，因为是位图，可以使用位运算，签到数据二进制最后一bit开始进行&运算，每一次&运算后将签到数据往右移一位，相当于移除最后一个bit位，直到遇到&计算第一次结果为0停止，统计运算的次数即连续签到的天数。

#### 积分功能
用户签到、学习、参与互动问答、提交学习笔记等行为都可以产生积分，并基于积分形成排行榜。
##### 积分规则
1. 签到规则
    连续7天奖励10分 连续14天 奖励20 连续28天奖励40分， 每月签到进度当月第一天重置
2. 学习规则 
	每学习一小节，积分+10，每天获得上限50分
3. 交互规则（有效交互数据参与积分规则，无效数据会被删除）  
4. 写评价 积分+10
5. 写问答 积分+5 每日获得上限为20分 
6. 写笔记 积分+3 每次被采集+2 每日获得上限为20分
##### 新增积分
由积分规则可知，获取积分的行为多种多样，而且每一种行为都有自己的独立业务。而这些行为产生的时候需要保存一条积分明细到数据库。
因为项目采用了微服务架构，各个服务之间相互独立开发，新增积分的功能应该由积分服务往数据库中新增一条积分记录，而不是由其他服务帮积分服务增加。这么做是为了降低业务之间的耦合性，采用异步方式，因为异步方式，使用MQ这一消息中间件，其他业务达到了获得积分的要求后，发送一条异步通知给积分功能，由积分功能监听，当监听到消息后，会调用PointsRecordService的addPointsRecord处理，处理时按照积分类型的不同分别存入数据库。